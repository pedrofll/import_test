name: Import PowerPlanet

on:
  workflow_dispatch: {}
  schedule:
    # GitHub cron es UTC. Para clavar 16:00 Europe/Madrid todo el a√±o (CET/CEST),
    # lanzamos a 14:00 UTC y filtramos por hora local.
    - cron: "0 14 * * *"

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4 pillow woocommerce

      - name: Gate to 16:00 Europe/Madrid
        run: |
          HOUR=$(TZ=Europe/Madrid date +%H)
          echo "Madrid hour: $HOUR"
          if [ "$HOUR" != "16" ]; then
            echo "Not 16:00 in Madrid. Skipping."
            exit 0
          fi

      - name: Run importer
        env:
          WP_URL: ${{ secrets.WP_URL }}
          WP_KEY: ${{ secrets.WP_KEY }}
          WP_SECRET: ${{ secrets.WP_SECRET }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_APP_PASS: ${{ secrets.WP_APP_PASS }}
        run: |
          python powerplanet.py --max-products 0 --sleep 0.7 --timeout 25 --status publish --jsonl powerplanet.jsonl

